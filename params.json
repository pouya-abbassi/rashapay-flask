{
  "name": "Rashapay-flask",
  "tagline": "ماژول پرداخت آنلاین راشاپی نسخه‌ی فلسک | rashapay.com Flask module",
  "body": "### ماژول پایتون درگاه پرداخت راشاپی\r\n[درگاه پرداخت راشاپی](http://rashapay.com) محیطی امن برای تراکنشهای مالی شماست. با استفاده از این اسکریپت پایتون که برای فریموورک Flask طراحی شده، میتوانید وبسایتهای خود را به درگاه پرداخت مجهز کنید.\r\n\r\n### نصب نیازمندیها\r\nنیازمندیهای مورد نیاز برای این اسکریپت، در فایلی به نام requirements.txt ذخیره شده که میتوانید با اجرای زیر آنها را نصب کنید:\r\n\r\n`pip install -r requirements.txt`\r\n\r\nاسکریپت برای پایتون ورژن 2.7 نوشته شده ولی مشکلی با ورژن 3.5 نیز نخواهید داشت. در بالای اسکریپت و پس از توضیحات، کتابخانه‌های `flask`، `urllib`، `json` و `random` فراخوانی شده‌اند.\r\n\r\nکتابخانه‌ی flask برای راه‌اندازی فریموورک flask و همچنین ایجاد امکان نمایش سایت در بروزر فراخوانی میشود. تابع `request` برای پردازش ریکوئستهای `POST` که به صفحه‌ها ارسال میشود مورد استفاده قرار میگرد و از `redirect` برای انتقال کاربر به صفحه‌ی پرداخت استفاده میکنیم. جهت صرفه جویی در مصرف منابع سیستم، به جای کد import flask از کد `from flask import flask, requst, redirect` استفاده شده که فقط توابع مورد نیاز فراخوانی شوند.\r\n\r\nکتابخانه‌ی urllib برای فرستادن درخواست به وب‌سرویس و دریافت پاسخ از وب‌سرویس مورد استفاده قرار میگیرد. اطلاعات به صورت فورم post ارسال میشوند.\r\n\r\nکتابخانه‌ی json برای پردازش اطلاعات دریافتی از وب‌سرویس مورد استفاده قرار میگیرد. اطلاعات به صورت آبجکت json دریافت میشوند.\r\n\r\nکتابخانه‌ی random برای تولید orderid به صورت رندوم مورد استفاده قرار میگیرد. این متغیر برای هر تراکنش باید عددی متفاوت از نوع اعداد صحیح باشد.\r\n\r\n### معرفی متغیرها\r\nجهت اتصال به سرویس راشاپی و پرداخت آنلاین، شما به یک کد تحت نام CKey نیاز دارید که میتوانید آنرا از قسمت «لیست سایتهای ثبت شده» در پنل راشاپی دریافت کنید. برای هر بار اتصال به سامانه‌ی پرداخت، این کد مورد نیاز است. آنرا در نمونه کد پایتون مقابل متغیر `consumer_key` قرار دهید. `‍‍consumer_key = \"1234:5678\"`. این متغیر از نوع Global میباشد و در تمام مراحل یکسان است.\r\n\r\nهر تراکنش، نیازمند یک orderid خاص و یکتا از نوع عدد صحیح میباشد که در اسکریپت حاظر، توسط تابع `rand()` تولید میشود.\r\n\r\n`orderid = random.randint(1,99999999999)`\r\n\r\nاین تابع در تمامی نسخه‌های پایتون موجود است و برای استفاده از آن باید کد import random در بالای اسکریپت نوشته شود. کد `‍orderid = random.randint(1,99999999999)` که برای ایجاد کد تصادفی نوشته شده است، در صفحه‌ی request قرار داده شده بنابر این،متغیر orderid به صورت Local میباشد و فقط در همین صفحه وجود دارد. (در صفحه‌‌ی callback هم به آن نیاز داریم ولی از طریق متد post از طرف درگاه پرداخت دریافت میشود)\r\n\r\nمتغیر callback حاوی آدرس بازگشت درگاه پرداخت است. آدرسی که کاربر پس از پرداخت موفق یا ناموفق، به آن بازگردانده میشود. `‍‍callback = \"http://localhost/callback\"` این متغیر Global میباشد.\r\n\r\nمتغیر amount حاوی مبلغ تراکنش به ریال و به صورت عدد صحیح میباشد. حداقل میزان مجاز، ۱۰۰۰ میباشد. amount = \"1000\". این متغیر توسط مشتری پر میشود.\r\n\r\nمتغیرهای name، email، mobile و description نیز توسط مشتری پر میشوند.\r\n\r\n\r\n***\r\n# انجام تراکنش\r\n\r\n### ارسال اطلاعات به وب‌سرویس\r\nاطلاعاتی که در متغیرهای ذکر شده وارد شدند، باید توسط متد post به آدرس وب سرویس ([http://rashapay.com/srv/rest/rpaypaymentrequest](http://rashapay.com/srv/rest/rpaypaymentrequest)) ارسال شوند. این متغیرها ابتدا توسط `urllib.urlencode` در آبجکتی به نام data ذخیره شده و سپس توسط `urllib.urlopen` به نشانی ذکر شده ارسال میشوند. برای استفاده از urllib باید آنرا نصب و فراخوانی کنید که فراخوانی آن توسط کد `import urllib` انجام شده است.\r\n\r\n### خواندن اطلاعات دریافتی از وب‌سرویس\r\nپاسخ دریافتی از وب‌سرویس در متغیری به نام `u` ریخته شده و سپس توسط `u.read()` خوانده شده و درون آبجکتی به نام obj ذخیره میشوند که آبجکتی از نوع json میباشد. برای پردازش آبجکت جیسون، نیاز به نصب و فراخوانی آن در برنامه دارید که توسط کد `import json` در اسکریپت فراخوانی میشود. برای دیکد کردن این آبجکت، از دستور `json.loads(obj)` استفاده میکنیم و نتیجه را در `parsed_json` نگهداری میکنیم.\r\n\r\n### پردازش اطلاعات دریافتی از وب‌سرویس\r\nپاسخ دریافتی از وب‌سرویس به صورت یک آبجکت json خواهد بود که حاوی فاکتوری به نام `status` میباشد. فاکتور status مشخص کننده‌ی وضعیت درستی یا نادرستی اطلاعات ارسال شده به وب‌سرویس میباشد.\r\n\r\nاگر status برابر با `response` بود، آنگاه اطلاعات ارسالی به وب‌سرویس صحیح بوده و تراکنش امکان پذیر است. در این صورت، فاکتور دیگری با نام `token` نیز دریافت میشود که حاوی یک string از نوع hash میباشد که با اضافه کردن آن به انتهای نشانی [http://rashapay.com/srv/gatewaychannel/requestpayment/](http://rashapay.com/srv/gatewaychannel/requestpayment/) آدرس پرداخت به دست می‌آید. به عنوان مثال:\r\n\r\n[‍‍http://rashapay.com/srv/gatewaychannel/requestpayment/CSsL11DshoT1ebUPq7jMby36qzNztE](‍‍http://rashapay.com/srv/gatewaychannel/requestpayment/CSsL11DshoT1ebUPq7jMby36qzNztE)\r\n\r\nاگر مقدار status برابر با اعداد ۱۱ الی ۱۷ بود، از طریق `if/elif`های تودرتو، کد خطای مربوطه پیدا شده و نمایش داده میشود. کدهای خطا مطابق جدول زیر میباشد:\r\n\r\nstatus|توضیح\r\n-------------|-------------\r\nresponse|مشخصات ارسالی صحیح است. با استفاده از توکن، آدرس پرداخت را بسازید.\r\n11|مشخصات ارسالی نادرست است.\r\n12|اتصال به وب‌سرویس ناموفق است.\r\n13|IP سایت درخواست کننده با IP ثبت شده در سیستم راشا‌پرداخت مطابقت ندارد.\r\n14|شماره‌ی سفارش ارسالی (orderid) تکراری است.\r\n15|فرمت مبلغ نامعتبر است.\r\n16|فرمت ایمیل نامعتبر است.\r\n17|نشانی callback تعریف نشده است.\r\n\r\n***\r\n# بازگشت از تراکنش و تست وضعیت\r\n### پردازش اطلاعات دریافتی از وب‌سرویس\r\nزمانی که کاربر به صفحه‌ی callback منتقل میشود، اطلاعاتی از طریق متد post به این صفحه فرستاده میشوند که درستی یا نادرستی تراکنش را نشان میدهند. بنابراین در تعریف صفحه‌ی callback نیاز به تعریف متد post داریم.\r\n`@app.route(\"/callback\", methods=['post'])`\r\n\r\n\r\nاگر وبسایت شما از دیتابیس پشتیبانی میکند، در این مرحله و پس از اطمینان از صحت تراکنش، اطلاعات کاربر و تراکنش وی را در دیتابیس ذخیره کنید.\r\n\r\nدر صفحه‌ی callback عملیات پردازش، ارسال و دریافت اطلاعات مشابه صفحه‌های دیگر انجام میشود پس از توضیح مسائل تکراری اجتناب میشود.\r\n\r\nوضعیت کلی اطلاعات بازگشت به دو صورت میباشد که اگر status برابر با response بود، دو حالت ممکن است برای متغیر code وجود داشته باشد. در حالتی که code برابر با 0 بود یعنی تراکنش موفق بوده و اگر برابر با 10 بود یعنی تراکنش ناتمام میباشد.\r\n\r\nاگر status برابر با response نبود، و برابر با یکی از اعداد 11، 12، 13 ویا 18 بود، از طریق جدول زیر میتوان خطایابی را انجام داد.\r\n\r\nstatus|توضیح\r\n-------------|-------------\r\nresponse|اگر کد برابر با 0 بود، تراکنش موفق و اگر برابر با 10 بود تراکنش ناتمام است.\r\n11|مشخصات ارسالی نادرست است.\r\n12|اتصال به وب‌سرویس ناموفق است.\r\n13|IP سایت درخواست کننده با IP ثبت شده در سیستم راشا‌پرداخت مطابقت ندارد.\r\n18|تراکنشی با مشخصات ارسالی موجود نیست.",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}